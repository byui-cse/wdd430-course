-- 1. Create the 'projects' table
create table public.projects (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default now() not null,
  name text not null,
  description text
);

-- 2. Create the 'scorecards' table
create table public.scorecards (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default now() not null,
  
  -- Link to the project. If a project is deleted, delete its scorecards.
  project_id uuid references public.projects(id) on delete cascade not null,
  
  stack_name text not null,
  scorable_by text,
  date_scored date default current_date,
  notes text,

  -- We use JSONB for the category metrics. 
  -- This allows you to add new metrics (like Speed Index) in the Svelte code 
  -- without needing to constantly migrate the database schema.
  score_performance_raw jsonb default '{}'::jsonb,
  score_bundle_raw jsonb default '{}'::jsonb,
  score_dx_raw jsonb default '{}'::jsonb,
  score_operational_raw jsonb default '{}'::jsonb,

  -- We store the final calculated score as a separate column 
  -- so we can easily sort and query the "Winner" without parsing JSON.
  final_score_snapshot numeric
);

-- 3. Enable Row Level Security (RLS)
-- This is a Supabase best practice to secure your data.
alter table public.projects enable row level security;
alter table public.scorecards enable row level security;

-- 4. Create Access Policies
-- CAUTION: These policies allow anyone with your API key (including the public key)
-- to Read and Write. For an internal bakeoff tool, this is usually fine.
-- If you add User Auth later, you will want to restrict this to 'authenticated' users.

-- Allow read/write access to 'projects'
create policy "Enable read access for all users" on public.projects
  for select using (true);

create policy "Enable insert access for all users" on public.projects
  for insert with check (true);

-- Allow read/write access to 'scorecards'
create policy "Enable read access for all users" on public.scorecards
  for select using (true);

create policy "Enable insert access for all users" on public.scorecards
  for insert with check (true);

-- Create a table to store a passcode

-- 1. Create the schema first
create schema if not exists private;

-- 2. Create the table in that schema
create table private.app_secrets (
  key text primary key,
  value text not null
);

-- 3. Enable RLS (Security Best Practice)
alter table private.app_secrets enable row level security;

-- 4. Insert your passcode
insert into private.app_secrets (key, value)
values ('bakeoff_passcode', 'Eureka!');

-- Create a function to check the code

create or replace function public.authorize_bakeoff()
returns boolean as $$
declare
  passed_code text;
  valid_code text;
begin
  -- 1. Get the passcode sent by the client from the HTTP Headers
  -- Supabase puts current headers in a config variable
  passed_code := current_setting('request.headers', true)::json->>'x-bakeoff-passcode';

  -- 2. Get the real passcode from our private table
  select value into valid_code 
  from private.app_secrets 
  where key = 'bakeoff_passcode';

  -- 3. Return true if they match, false otherwise
  if passed_code = valid_code then
    return true;
  else
    return false;
  end if;
end;
$$ language plpgsql security definer;

-- add function to check code from API
create or replace function public.verify_passcode(input_code text)
returns boolean as $$
declare
  valid_code text;
begin
  -- Fetch the real secret
  select value into valid_code 
  from private.app_secrets 
  where key = 'bakeoff_passcode';

  -- Compare input directly
  if input_code = valid_code then
    return true;
  else
    return false;
  end if;
end;
$$ language plpgsql security definer;

-- update row level security

-- 1. Projects Table
alter table public.projects enable row level security;

create policy "Passcode required for projects"
on public.projects
for all -- covers select, insert, update, delete
using ( public.authorize_bakeoff() )
with check ( public.authorize_bakeoff() );

-- 2. Scorecards Table
alter table public.scorecards enable row level security;

create policy "Passcode required for scorecards"
on public.scorecards
for all
using ( public.authorize_bakeoff() )
with check ( public.authorize_bakeoff() );

-- ============================================
-- Peer Review tables (passcode-protected)
-- ============================================

create table if not exists public.peer_review_teams (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default now() not null,
  team_name text not null,
  members jsonb not null default '[]'::jsonb
);

create table if not exists public.peer_reviews (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default now() not null,
  team_id uuid references public.peer_review_teams(id) on delete cascade not null,
  reviewer_name text not null,
  responses jsonb not null default '[]'::jsonb
);

create index if not exists idx_peer_reviews_team_id on public.peer_reviews(team_id);

alter table public.peer_review_teams enable row level security;
alter table public.peer_reviews enable row level security;

create policy "Passcode required for peer_review_teams"
on public.peer_review_teams
for all
using ( public.authorize_bakeoff() )
with check ( public.authorize_bakeoff() );

create policy "Passcode required for peer_reviews"
on public.peer_reviews
for all
using ( public.authorize_bakeoff() )
with check ( public.authorize_bakeoff() );

-- ============================================
-- Project -> Team linking + project review queue
-- ============================================

alter table public.projects
  add column if not exists team_id uuid references public.peer_review_teams(id) on delete set null,
  add column if not exists live_demo_url text,
  add column if not exists semester_code text;

create index if not exists idx_projects_team_id on public.projects(team_id);
create index if not exists idx_projects_semester_code on public.projects(semester_code);

alter table public.peer_review_teams
  add column if not exists semester_code text;

create index if not exists idx_peer_review_teams_semester_code
  on public.peer_review_teams(semester_code);

create table if not exists public.project_peer_reviews (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default now() not null,
  project_id uuid references public.projects(id) on delete cascade not null,
  team_id uuid references public.peer_review_teams(id) on delete set null,
  reviewer_name text not null,
  ux_rating numeric not null check (ux_rating >= 1 and ux_rating <= 5),
  ui_rating numeric not null check (ui_rating >= 1 and ui_rating <= 5),
  usability_rating numeric not null check (usability_rating >= 1 and usability_rating <= 5),
  bugs_found text,
  likes text,
  dislikes text,
  suggestions text,
  additional_notes text
);

alter table public.project_peer_reviews
  add column if not exists reviewed_by_team boolean not null default false,
  add column if not exists reviewed_at timestamp with time zone;

create index if not exists idx_project_peer_reviews_project_id
  on public.project_peer_reviews(project_id);
create index if not exists idx_project_peer_reviews_created_at
  on public.project_peer_reviews(created_at desc);

alter table public.project_peer_reviews enable row level security;

create policy "Passcode required for project_peer_reviews"
on public.project_peer_reviews
for all
using ( public.authorize_bakeoff() )
with check ( public.authorize_bakeoff() );